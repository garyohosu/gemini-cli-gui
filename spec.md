# gemini-cli-gui 仕様書（MVP〜v1）

最終更新: 2026-02-03

## 0. 前提知識

### Gemini CLI とは
Google が提供する AI エージェント型の CLI ツール。ローカルの作業フォルダ（ワークスペース）を対象に、コード生成、ファイル操作、コマンド実行などを行える。

- 公式リポジトリ: https://github.com/google-gemini/gemini-cli
- 無料枠あり（Google アカウントで利用可能）

注:
- 利用条件、無料枠、認証方法などは変更される可能性があるため、最新情報は Gemini CLI の公式ドキュメントを参照すること。

### 類似ツール
- [Claude Code](https://github.com/anthropics/claude-code) - Anthropic の CLI ツール（有料）
- Claude Cowork - Claude Code の GUI 版

本プロジェクトは「無料で使える Claude Cowork のようなもの」を目指す。

## 1. 目的

**課金なし・コマンドラインなしで AI コーディングアシスタントを使えるようにする。**

Windows 向けに、Gemini CLI を「安全に」「分かりやすく」使うための GUI ラッパーを提供する。

狙い:
- **無料** - Gemini CLI の無料枠を活用し、課金なしで使える
- **GUI** - CLI が苦手なユーザーでも、チャット形式で依頼できる
- **安全** - 指定フォルダ（ワークスペース）外へのアクセスを強制的に遮断する
- **配布** - Python で実装し、exe 化して配布（ユーザーに Python を要求しない）

## 2. 想定ユーザー

- **CLI が苦手な人** - コマンドラインを使いたくないが、AI コーディングツールには興味がある
- **課金を避けたい人** - 有料サービス（GitHub Copilot, Claude Pro 等）を使わずに試したい
- Windows を使う一般ユーザー（事務職、教育関係、個人クリエイター等）
- 個人開発・実験としての利用

## 3. スコープ

MVP〜v1 で対応する範囲:
- ワークスペースフォルダの選択と固定
- チャット UI（入力、出力、履歴）
- Gemini CLI 実行（初回ウォームアップ含む）
- 安全なファイル操作（ワークスペース内限定）
- 変更提案のプレビュー（差分表示）と承認フロー
- 実行ログ（操作履歴、エラー、実行時間）
- exe 配布（PyInstaller を基本）

## 4. 非スコープ（v1ではやらない）

- クラウド同期、アカウント管理、チーム共有
- マクロのような常駐自動実行（スケジューラ連携）
- ワークスペース外にまたがる検索や一括操作
- OS 全体のコマンド実行を無制限に許可する設計
- プラグイン/拡張マーケット

## 5. 全体像（アーキテクチャ）

### 5.1 技術スタック（推奨）
- GUI: PySide6（または Tkinter。v1では PySide6 推奨）
- 実行制御: asyncio + subprocess（必要に応じて疑似TTY）
- セキュリティ: パス正規化、シンボリックリンク対策、操作の許可制
- 差分: difflib / 外部 diff ライブラリ（必要最低限から）
- 配布: PyInstaller（onefile もしくは onedir）
- CI: GitHub Actions（lint / unit test / build）

### 5.2 構成
```
┌──────────────────────────────────────────┐
│  Python GUI（チャット・承認・プレビュー） │
└───────────────┬──────────────────────────┘
                │ 呼び出し
┌───────────────▼──────────────────────────┐
│  Core（安全な操作層）                      │
│  - WorkspaceSandbox（パス検証）            │
│  - OperationPlanner/Approver（承認管理）   │
│  - Diff/Preview（変更プレビュー）          │
│  - AuditLog（操作ログ）                    │
└───────────────┬──────────────────────────┘
                │ 実行
┌───────────────▼──────────────────────────┐
│  GeminiCliAdapter（起動・入出力・監視）    │
│  - warm-up（初回遅延を吸収）               │
│  - 失敗時の再起動                          │
└───────────────┬──────────────────────────┘
                │ CLI
┌───────────────▼──────────────────────────┐
│  Gemini CLI（外部依存）                    │
└──────────────────────────────────────────┘
```

### 5.3 重要な設計方針
- ワークスペース外のパスは絶対に扱わない
- 破壊的操作（上書き/削除/移動/一括変更）は必ず承認を挟む
- 初回起動が遅い環境がある前提で、起動時にウォームアップする
- 「Gemini CLI に何でもやらせる」ではなく、アプリ側で安全を担保する

## 6. 重要要件（安全・安心）

### 6.1 ワークスペース制限（必須）
- ユーザーが選んだ 1 フォルダをワークスペースとする
- 以降の操作対象はワークスペース配下のみ
- 以下は必ずブロック:
  - パストラバーサル（..）
  - 絶対パス指定（C:\ など）
  - シンボリックリンク/ジャンクション経由で外へ出るケース
  - UNC パス、ネットワークドライブ（v1は原則非対応）

### 6.2 操作の許可制（必須）
v1 で許可する操作（例）:
- 読み取り: list / read / search
- 変更: write（新規/追記/上書き）/ rename / move / copy / mkdir
- 破壊: delete（要承認、既定はゴミ箱優先）
- まとめ: zip/unzip（要承認）

危険度が高い操作は、必ず「プレビュー → 承認 → 実行」の順にする。

### 6.3 変更プレビュー（必須）
- 実行前に変更点を提示する
- テキストは unified diff を基本とする
- バイナリや大容量は「変更の可能性」だけを示し、承認を強制する

### 6.4 監査ログ（必須）
- 実行した操作、対象パス、結果、所要時間、エラーを保存
- 保存先はワークスペース内の専用フォルダ、またはアプリ用データフォルダ
- 個人情報や API キー等をログに出さない（マスク）

## 7. Gemini CLI 連携仕様

### 7.1 初回ウォームアップ（必須）
- アプリ起動後、ユーザーの最初の依頼の前に 1 回だけ初期化を走らせる
- UI には「初回セットアップ中（初回のみ時間がかかる場合があります）」を表示
- ウォームアップが失敗した場合は、原因と対処（Gemini CLI の導入、認証等）をガイドする

### 7.2 実行モード（v1 推奨）
v1 は「提案 → 承認 → 実行」を基本にする。

- Gemini CLI には「やることの手順」と「変更内容（操作の列）」を出力させる
- アプリはその出力を読み、プレビューと承認 UI を出す
- 承認された操作だけをアプリ側の安全 API で実行する

注:
- Gemini CLI は本来ワークスペースを直接操作できるため、v1 の既定では安全側に寄せる。
- 安全性を最優先する場合は、将来オプションとして「一時コピー上で実行し、差分を反映する」方式も検討する（性能とトレードオフ）。

### 7.3 Gemini に要求する出力フォーマット
Gemini には「最終的に実行する操作」を機械可読で返してもらう。

例（擬似）:
- operations:
  - type: write
    path: "docs/readme.txt"
    mode: "overwrite"
    content: "..."
  - type: move
    src: "a.txt"
    dst: "archive/a.txt"

v1 では、まずは簡易パーサ（区切り行 + YAML 風）で開始し、安定後に JSON Schema に寄せる。

### 7.4 エラー処理
- Gemini CLI が落ちたら自動再起動（最大 3 回）
- 認証が必要な状態は、ユーザーにブラウザでの操作を促す
- タイムアウトは「初回」「通常」で別設定にする

### 7.5 エラー分類

| コード | 分類 | 原因例 | ユーザーへの案内 |
|--------|------|--------|------------------|
| E001 | CLI未検出 | Gemini CLI がインストールされていない | Node.js と Gemini CLI のインストール手順を表示 |
| E002 | 認証エラー | Google アカウント未ログイン | ブラウザでの認証を促す |
| E003 | タイムアウト | CLI が応答しない | 再試行ボタンを表示、それでもダメなら再起動を促す |
| E004 | パス違反 | ワークスペース外へのアクセス試行 | 操作をブロックした旨を表示 |
| E005 | パースエラー | CLI 出力が解析できない | 操作を中断、ログを保存して報告を促す |
| E006 | 操作失敗 | ファイル操作が失敗（権限等） | 具体的なエラー内容と対処法を表示 |

## 8. チャット体験（主要フロー）

### 8.1 初回起動
1. ワークスペース選択
2. Gemini CLI の検出
   - 見つからない場合: インストール手順を案内
3. 認証が必要な場合: ブラウザでログイン
4. ウォームアップ実行
5. 使い方の最小ガイド表示

### 8.2 通常操作フロー
1. ユーザーが依頼を入力
2. アプリがワークスペース状況（必要最低限）をまとめて Gemini に渡す
3. Gemini が「手順」と「operations」を出力
4. アプリがプレビューを表示し、承認を求める
5. 承認された操作だけを実行
6. 結果をチャットに表示し、ログに記録

### 8.3 中断とロールバック
- 長時間操作は中断ボタンを用意する
- v1 のロールバックは「上書き前にバックアップ作成」を基本とする

### 8.4 バックアップ仕様
- 保存先: ワークスペース内の `.gemini-gui-backup/` フォルダ
- 命名規則: `{元ファイル名}.{タイムスタンプ}.bak`
- 保持期間: 7日間（超過分は起動時に自動削除）
- 最大サイズ: 100MB/ワークスペース（超過時は古いものから削除）

## 9. UI要件

- 画面は「ワークスペース」「チャット」「承認/プレビュー」の3要素を中心にする
- 破壊的操作の承認は目立つ表示にし、既定はキャンセル
- エラー表示は「原因」「対処（次にやること）」まで出す
- 初回の遅延（ウォームアップ）は進捗表示を出す

## 10. 配布・インストール要件

### 10.1 配布方法
- GitHub Releases に exe を置く
- v1 は自動更新を必須にしない（将来検討）

### 10.2 exe 化と配布形式

**Step 1: exe 化**
- PyInstaller を使用（onefile または onedir）

**Step 2: パッケージ化・署名（推奨）**
- WinApp CLI (`winget install microsoft.winappcli`) を使用
- MSIX パッケージ化 + 署名により Windows Defender 誤検知を回避
- 参考: https://note.com/hantani/n/n0e8bcd0ea4c7

```
PyInstaller で exe 作成
    ↓
winapp init（マニフェスト・証明書生成）
    ↓
winapp pack（MSIX パッケージ作成）
    ↓
winapp sign（署名）
    ↓
GitHub Releases で配布
```

**v1 方針**
- まず PyInstaller の exe のみで動作確認
- 誤検知が問題になったら MSIX 化を導入

### 10.3 外部依存（Gemini CLI）
v1 では以下のいずれかを採用する。

- Option A（v1 推奨）: ユーザーに Node.js と Gemini CLI をインストールしてもらう
  - アプリは起動時に `gemini` コマンドの存在をチェック
  - 無い場合は手順を案内する
- Option B（将来）: portable Node + Gemini CLI を同梱（更新・容量・ライセンス確認が課題）

### 10.4 システム要件
- Windows 10/11 64bit
- インターネット接続（Gemini の通信）
- ディスク空き容量（ログ/バックアップ分を含む）

## 11. 開発マイルストーン

### M0（技術検証）※ 最重要フェーズ

過去の試行で課題があったため、M0 は慎重に進める。各項目を個別に検証し、問題があれば仕様にフィードバックする。

**過去の試行（Electron版）で判明した問題:**
- コマンドのパラメータ渡しで 1回あたり約90秒かかった
- 原因の特定と解決ができなかったため、Python で作り直すことにした
- Python 版では exe 化して配布し、ユーザーに Python 環境構築を要求しない

#### M0-1: Gemini CLI 基本動作確認
- [ ] Gemini CLI のインストール・認証フローを手動で確認
- [ ] `gemini` コマンドの基本的な使い方を調査
- [ ] 無料枠の制限（リクエスト数、レート制限）を確認

#### M0-2: subprocess 連携
- [ ] Python から subprocess で Gemini CLI を起動できるか
- [ ] stdin/stdout の取得方法（パイプ、疑似 TTY）
- [ ] 初回起動の遅延（ウォームアップ）の計測
- [ ] 長時間実行時の挙動（タイムアウト、中断）

#### M0-3: 出力フォーマット調査
- [ ] Gemini CLI がどのような形式で出力を返すか
- [ ] 機械可読な形式（JSON 等）で出力させる方法があるか
- [ ] 出力のパース可能性を検証

#### M0-4: WorkspaceSandbox
- [ ] パス正規化のユニットテスト
- [ ] パストラバーサル対策のテスト
- [ ] シンボリックリンク対策のテスト

#### M0 完了条件
- 上記すべての検証結果をドキュメント化
- 技術的に実現可能かの判断
- 実現困難な場合は代替案を検討

### M1（MVP）
- チャット UI（最小限）
- Gemini CLI との基本的なやり取り
- ワークスペース選択

### M2（v1）
- operations のパースと承認 UI
- 基本操作（read/write/move/mkdir）＋ログ
- diff プレビュー
- PyInstaller で exe 作成、Releases 配布

## 12. テスト方針

### 12.1 ユニットテスト
- WorkspaceSandbox（パス検証）: パストラバーサル、シンボリックリンク等の攻撃パターン
- 操作パーサ: 正常系・異常系の入力パターン

### 12.2 結合テスト
- Gemini CLI との連携: モック/実際の CLI 両方でテスト
- ファイル操作: 実際のファイルシステムでの動作確認

### 12.3 セキュリティテスト
- ワークスペース脱出の試行（手動）
- 既知の攻撃パターンに対する防御確認

### 12.4 ツール
- pytest（ユニットテスト）
- GitHub Actions（CI: lint + test）

## 13. 受け入れ条件（v1）

- ワークスペース外への操作がブロックされる（パス脱出、リンク経由を含む）
- 破壊的操作は必ず承認が必要
- 初回ウォームアップ後、通常操作が実用速度で動く
- 操作ログが残り、失敗時に原因が追える
- exe を配布でき、ユーザーは Python を入れずに起動できる

## 14. 追加検討項目

- 一時コピー実行（安全最優先モード）
- 署名、MSIX 化、Defender 誤検知対策
- Gemini の出力フォーマットの厳格化（JSON Schema）
- 多言語 UI（将来）

## 15. FAQ

Q. 初回だけ遅い  
A. 初回起動では認証や初期化が走る場合がある。アプリは起動時にウォームアップして待ち時間を吸収する。

Q. ワークスペース外のファイルも整理したい  
A. v1 では安全のため非対応。別のワークスペースとして開き直す。

## 16. リスクと対策

- Gemini 出力が揺れる
  - 対策: 出力フォーマットを固定し、パース失敗時は承認を出さず中断
- exe の誤検知
  - 対策: 署名、MSIX 化、ビルドの再現性、配布導線の明確化
- ユーザー環境差（Node/Gemini CLI）
  - 対策: 起動時診断とセットアップガイド

## 付録A: 参考
- Gemini CLI 公式リポジトリ: https://github.com/google-gemini/gemini-cli
- PyInstaller ドキュメント: https://pyinstaller.org/
- Python exe化・安全な配布方法: https://note.com/hantani/n/n0e8bcd0ea4c7
